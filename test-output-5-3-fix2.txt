
> kapi-s-rpg@0.1.0 test
> jest tests/integration/prompts/template-engine.test.js

  console.debug
    [PromptTemplateEngine] Warning: Template location-return exceeds token budget by 17.7% (706 tokens vs 600 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:597:21)

  console.debug
    [PromptTemplateEngine] Warning: Template npc-dialogue exceeds token budget by 110.0% (840 tokens vs 400 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:597:21)

  console.debug
    [PromptTemplateEngine] Warning: Template combat-narration exceeds token budget by 93.4% (967 tokens vs 500 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:597:21)

  console.debug
    [PromptTemplateEngine] Warning: Template consistency-validation exceeds token budget by 252.7% (1058 tokens vs 300 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:597:21)

  console.debug
    [PromptTemplateEngine] Warning: Context has unused fields (possible typos): metadata, events, quests, contextMarkdown

      at PromptTemplateEngine.debug [as _checkUnusedFields] (src/prompts/template-engine.js:264:19)

  console.debug
    [PromptTemplateEngine] Warning: Template location-return exceeds token budget by 16.2% (697 tokens vs 600 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:597:21)

  console.debug
    [PromptTemplateEngine] Warning: Template npc-dialogue exceeds token budget by 102.0% (808 tokens vs 400 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:597:21)

  console.debug
    [PromptTemplateEngine] Registered custom template: custom-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:448:17)

  console.debug
    [PromptTemplateEngine] Registered custom template: custom-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:448:17)

  console.debug
    [PromptTemplateEngine] Registered custom template: custom-list-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:448:17)

  console.debug
    [PromptTemplateEngine] Registered custom template: duplicate-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:448:17)

  console.debug
    [PromptTemplateEngine] Warning: Context has unused fields (possible typos): self

      at PromptTemplateEngine.debug [as _checkUnusedFields] (src/prompts/template-engine.js:264:19)

PASS tests/integration/prompts/template-engine.test.js
  PromptTemplateEngine
    Test Suite 1 - Template Rendering (AC-1, AC-2)
      √ should render location-initial-visit template with valid context (14 ms)
      √ should render location-return template with state changes (31 ms)
      √ should render npc-dialogue template with personality (8 ms)
      √ should render combat-narration template with damage (5 ms)
      √ should render consistency-validation template with rules (5 ms)
    Test Suite 2 - Variable Substitution (AC-1, AC-5)
      √ should substitute simple variables (2 ms)
      √ should substitute nested object properties (2 ms)
      √ should substitute array iterations with {{#each}} (2 ms)
      √ should handle optional variables with defaults (3 ms)
      √ should handle empty arrays gracefully (2 ms)
    Test Suite 3 - Token Budget Validation (AC-4)
      √ should include tokenCount in result metadata (2 ms)
      √ should include tokenBudget in result metadata (2 ms)
      √ should warn if token count exceeds budget by >10% but not block rendering (3 ms)
    Test Suite 4 - Missing Variable Handling (AC-5)
      √ should return error if required variable missing (2 ms)
      √ should identify all missing variables in error message (1 ms)
      √ should succeed if all required variables present (even if some optional missing) (2 ms)
    Test Suite 5 - Epic Integration (AC-6)
      √ should work with Story 5-1 ContextObject structure (9 ms)
      √ should access nested Epic 1-4 data correctly (4 ms)
    Test Suite 6 - DM Persona Integration (AC-3)
      √ should prepend DM persona to all rendered templates (4 ms)
      √ DM persona should appear before template content (2 ms)
      √ DM persona should be cached after first load (3 ms)
    Test Suite 7 - Template Caching (AC-1)
      √ should cache template after first load (2 ms)
      √ should cache multiple templates independently (5 ms)
    Test Suite 8 - Custom Templates (AC-1)
      √ should register custom template successfully (4 ms)
      √ should render registered custom template (3 ms)
      √ should list all available templates including registered ones (7 ms)
      √ should throw error if registering duplicate template (39 ms)
    Edge Cases and Error Handling
      √ should handle null or undefined context gracefully (1 ms)
      √ should handle invalid template ID
      √ should handle empty template ID (4 ms)
      √ should handle circular references in context gracefully (3 ms)

Test Suites: 1 passed, 1 total
Tests:       31 passed, 31 total
Snapshots:   0 total
Time:        1.469 s, estimated 2 s
Ran all test suites matching /tests\\integration\\prompts\\template-engine.test.js/i.
