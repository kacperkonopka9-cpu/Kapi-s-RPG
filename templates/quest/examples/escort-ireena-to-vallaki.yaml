# Escort Ireena to Vallaki - Main Quest
# Source: Curse of Strahd p.43
# Critical early-game quest that drives party toward Vallaki

# === BASIC INFORMATION ===
questId: "escort_ireena_to_vallaki"
name: "Escort Ireena to Vallaki"
type: "main"
category: "story"

# === QUEST GIVERS & RECIPIENTS ===
questGiver:
  npcId: "ismark_kolyanovich"
  location: "village_of_barovia_burgomaster_mansion"
  dialogue: "My sister Ireena is in grave danger. Strahd has taken an interest in her - he's bitten her twice already. We must get her to safety in the fortified town of Vallaki. Will you help escort her there?"

questRecipient: "player"

# === QUEST DESCRIPTION ===
description:
  short: "Escort Ireena Kolyana to the safety of Vallaki"
  full: "Ireena Kolyana, adopted daughter of the late Burgomaster, has been targeted by Strahd von Zarovich himself. The vampire lord has visited her twice, biting her neck and draining her blood. Her brother Ismark fears Strahd will return to claim her. The only hope is to escort Ireena to Vallaki, a fortified town to the west, where the church of St. Andral might offer sanctuary. The journey is dangerous - wolves, zombies, and Strahd's spies patrol the roads of Barovia."

# === QUEST STATUS ===
status: "not_started"

# === PREREQUISITES ===
prerequisites:
  level: null  # Available at level 1

  requiredQuests:
    completed: ["bury_the_burgomaster"]  # Must bury Kolyan first

  requiredEvents: []

  requiredNPCs:
    alive: ["ismark_kolyanovich", "ireena_kolyana"]
    dead: []

  requiredItems: []

  requiredLocations:
    visited: ["village_of_barovia"]

# === OBJECTIVES ===
objectives:
  - objectiveId: "accept_quest"
    description: "Agree to escort Ireena to Vallaki"
    type: "dialogue"
    status: "pending"
    target:
      type: "npc"
      id: "ismark_kolyanovich"
      location: "village_of_barovia_burgomaster_mansion"
    optional: false
    completionTrigger:
      type: "dialogue_complete"
    rewards:
      experience: 0

  - objectiveId: "prepare_for_journey"
    description: "Gather supplies and prepare Ireena for the journey"
    type: "preparation"
    status: "pending"
    optional: true
    completionTrigger:
      type: "manual"  # Player decides when ready
    rewards:
      experience: 0

  - objectiveId: "travel_to_vallaki"
    description: "Safely escort Ireena along the road from Barovia to Vallaki"
    type: "escort"
    status: "pending"
    target:
      type: "npc"
      id: "ireena_kolyana"
      destination: "vallaki"
    optional: false
    completionTrigger:
      type: "npc_reaches_location"
      npcId: "ireena_kolyana"
      locationId: "vallaki"
    rewards:
      experience: 400

  - objectiveId: "find_sanctuary"
    description: "Deliver Ireena to the Church of St. Andral or the Burgomaster's mansion in Vallaki"
    type: "delivery"
    status: "pending"
    target:
      type: "location"
      id: "vallaki_church_of_st_andral"
    optional: false
    completionTrigger:
      type: "npc_reaches_location"
      npcId: "ireena_kolyana"
      locationId: "vallaki_church_of_st_andral"
    rewards:
      experience: 100

# === TIME CONSTRAINTS ===
timeConstraints:
  hasDeadline: true
  deadline:
    date: "735-10-10"  # 7 days from typical quest start (10-03)
    time: "23:59"
  failOnMissedDeadline: false  # Strahd attacks but quest doesn't auto-fail
  warningThreshold: 2  # Warn 2 days before

# === CONSEQUENCES ===
consequences:
  onCompletion:
    stateChanges:
      - type: "npc_status"
        npcId: "ireena_kolyana"
        status: "safe_in_vallaki"
        location: "vallaki_church_of_st_andral"

      - type: "location_state"
        locationId: "vallaki"
        changes:
          ireena_arrived: true
          party_reputation: "helpful"

      - type: "npc_attitude"
        npcId: "ismark_kolyanovich"
        attitudeChange: +30
        trustLevel: 10

    triggeredEvents:
      - eventId: "strahd_learns_ireenas_location"
        delay: "1d3"  # Strahd learns in 1-3 days
        notes: "Strahd will eventually find Ireena in Vallaki"

      - eventId: "bones_of_st_andral_theft"
        delay: "2d4"  # Bones stolen 2-4 days later
        notes: "Sets up St. Andral's Feast side quest"

    unlockedQuests:
      - "st_andrals_feast"
      - "vallaki_politics"

    npcReactions:
      - npcId: "ismark_kolyanovich"
        attitudeChange: +30
        dialogue: "You've done more for my family than I can ever repay. Thank you, truly."

      - npcId: "ireena_kolyana"
        attitudeChange: +20
        dialogue: "I feel safer here... for now. But I fear Strahd will find me, no matter where I hide."

      - npcId: "father_lucian_petrovich"
        attitudeChange: +10
        dialogue: "You bring this poor girl to our church? Very well. May the Morninglord protect her."

  onFailure:
    stateChanges:
      - type: "npc_status"
        npcId: "ireena_kolyana"
        status: "captured_by_strahd"

      - type: "world_state"
        key: "ireena_fate"
        value: "taken"

    triggeredEvents:
      - eventId: "ireena_taken_by_strahd"
        delay: "0"
        notes: "Strahd spirits Ireena to Castle Ravenloft"

    npcReactions:
      - npcId: "ismark_kolyanovich"
        attitudeChange: -50
        dialogue: "You promised to protect her... and you failed. My sister is lost."
        newStatus: "despondent"  # May become suicidal

    canRetry: false  # Ireena is gone if failed

  onAbandonment:
    stateChanges:
      - type: "npc_attitude"
        npcId: "ismark_kolyanovich"
        attitudeChange: -20

    npcReactions:
      - npcId: "ismark_kolyanovich"
        dialogue: "So you won't help us after all. I understand... everyone fears Strahd."

    canRestart: true

# === REWARDS ===
rewards:
  experience: 500  # Total for completing all objectives

  items: []  # No item rewards (this is a favor quest)

  currency:
    gold: 0
    silver: 0
    copper: 0

  reputation:
    - faction: "village_of_barovia"
      change: +10
    - faction: "vallaki"
      change: +5

  specialRewards:
    - type: "npc_ally"
      npcId: "ismark_kolyanovich"
      description: "Ismark becomes a loyal ally who may join party later"

    - type: "quest_unlock"
      questId: "st_andrals_feast"
      description: "Unlocks major Vallaki quest chain"

# === BRANCHING & CHOICES ===
branches:
  - branchId: "madam_eva_detour"
    description: "Player can detour to visit Madam Eva's camp for Tarokka reading"
    decision:
      prompt: "You pass the Vistani camp at Tser Pool. Ireena mentions rumors of a fortune teller. Do you stop?"
      choices:
        - choiceId: "visit_camp"
          description: "Stop at the Vistani camp"
          consequences:
            - type: "quest_unlock"
              questId: "madame_evas_tarokka_reading"
            - type: "time_advance"
              hours: 2

        - choiceId: "bypass_camp"
          description: "Continue directly to Vallaki"
          consequences:
            - type: "time_saved"
              hours: 2

  - branchId: "church_or_mansion"
    description: "Where to deliver Ireena in Vallaki"
    decision:
      prompt: "You've reached Vallaki. Do you take Ireena to the Church of St. Andral or the Burgomaster's mansion?"
      choices:
        - choiceId: "church"
          description: "Church of St. Andral (safer, canonical)"
          consequences:
            - type: "npc_location"
              npcId: "ireena_kolyana"
              location: "vallaki_church_of_st_andral"
            - type: "quest_unlock"
              questId: "st_andrals_feast"

        - choiceId: "mansion"
          description: "Burgomaster's mansion (political protection)"
          consequences:
            - type: "npc_location"
              npcId: "ireena_kolyana"
              location: "vallaki_burgomaster_mansion"
            - type: "npc_meeting"
              npcId: "baron_vargas_vallakovich"

# === JOURNAL ENTRIES ===
journalEntries:
  initial: "Ismark, son of the late Burgomaster of Barovia, has asked me to escort his sister Ireena to safety in Vallaki. Strahd von Zarovich himself has targeted her, biting her twice already. The journey will be dangerous, but Ireena's life depends on reaching the fortified town and finding sanctuary at the Church of St. Andral."

  updates:
    - trigger: "prepare_for_journey_complete"
      entry: "We've gathered supplies for the journey. Ireena is as ready as she'll ever be. Ismark wishes us luck - he'll remain in Barovia to protect the villagers."

    - trigger: "travel_to_vallaki_progress"
      entry: "The road to Vallaki winds through dark forests and mist-shrouded valleys. We've encountered [wolves/zombies/other threats] along the way. Ireena is holding up well, but I can see the fear in her eyes."

    - trigger: "vallaki_reached"
      entry: "We've reached Vallaki! The fortified town gates stand before us, guarded by stern-faced soldiers. Ireena seems relieved to see civilization again."

  completion: "Ireena is safe within the Church of St. Andral. Father Lucian has agreed to give her sanctuary. Ismark will be relieved to hear his sister is protected - at least for now. I suspect Strahd will not give up so easily."

  failure: "I have failed Ismark and Ireena. Strahd has taken her. I can still see the look of terror on her face as the vampire lord emerged from the mists and claimed her. Ismark will never forgive me."

# === INTEGRATION WITH EPIC 2 ===
eventSchedulerIntegration:
  registeredEvents:
    - eventId: "strahd_ambush_warning"
      trigger:
        type: "date_time"
        date: "735-10-08"
        time: "20:00"
      effect:
        type: "notification"
        message: "You feel watched. The mists seem to close in around you. Strahd knows you're moving Ireena."

    - eventId: "deadline_warning"
      trigger:
        type: "date_time"
        date: "735-10-08"
        time: "08:00"
      effect:
        type: "notification"
        message: "You've been delaying. Ismark looks anxious - Strahd could return for Ireena at any time."

# === AI DM GUIDANCE ===
dmGuidance:
  narrativeHooks:
    - "Emphasize the bite marks on Ireena's neck when she's first introduced"
    - "Have Ismark express guilt over his father's death and fear for Ireena"
    - "Foreshadow Strahd's obsession with Ireena (she's Tatyana reincarnated)"
    - "Ireena is brave but haunted by recurring nightmares of Strahd"

  roleplayTips:
    - "Ismark: Earnest, protective, carries guilt. Calls himself 'the Lesser' but is actually courageous"
    - "Ireena: Brave, practical, refuses to be helpless despite fear. Not a damsel - she'll fight if needed"
    - "Make the journey feel dangerous - wolves howling, mists closing in, distant screams"

  combatEncounters:
    - encounter: "dire_wolves"
      location: "road_to_vallaki"
      cr: 2
      notes: "2-3 dire wolves attack at night. Sent by Strahd to test the party?"

    - encounter: "zombie_ambush"
      location: "svalich_woods"
      cr: 1
      notes: "4-6 zombies rise from roadside graves"

    - encounter: "strahd_appearance"
      location: "any"
      cr: "none (roleplay)"
      notes: "Strahd may appear to taunt the party but doesn't attack yet. Psychological warfare."

  commonPitfalls:
    - "Players may try to kill Ireena thinking she's cursed/infected. She's not - Strahd wants her alive."
    - "Players may leave Ireena at Tser Pool camp. Vistani serve Strahd - bad idea."
    - "Players may take too long. Strahd's patience has limits. Use deadline warnings."

  alternatives:
    - "Players could take Ireena to Krezk instead (farther, harder, but also valid)"
    - "Players could attempt to hide Ireena in a random location (won't work - Strahd always finds her)"
    - "Players could try to bargain with Strahd (dangerous but possible)"

# === RELATIONSHIP TO OTHER QUESTS ===
relationships:
  partOfQuestChain:
    chainId: "ireena_arc"
    position: 2  # After "Bury the Burgomaster"

  blocksQuests:
    - "return_to_barovia_with_ireena"

  conflictsWith: []

# === DIFFICULTY & SCALING ===
difficulty:
  recommendedLevel: 3
  challengeRating: 2
  skillChecks:
    - skill: "persuasion"
      dc: 12
      context: "Convince Ireena to trust you"

    - skill: "survival"
      dc: 10
      context: "Navigate the forest roads"

    - skill: "insight"
      dc: 15
      context: "Notice Ireena is hiding something (Strahd's psychological hold)"

# === LORE & CONTEXT ===
lore:
  background: "Ireena Kolyana is the reincarnation of Tatyana, Strahd's lost love from 400 years ago. Strahd doesn't realize this consciously, but he's drawn to her with obsessive desire. He's visited her twice, biting her neck and marking her as his. Her father, Burgomaster Kolyan Indirovich, died from the stress of defending her. Her brother Ismark is desperate to get her to safety, but in Barovia, there is no true safety from Strahd."

  connectionToMainStory: "Ireena is central to Curse of Strahd's plot. Strahd's obsession with her drives much of the campaign. Eventually, she must either be protected until Strahd is defeated, or Strahd will claim her. Her fate affects the campaign's ending."

  historicalContext: "Tatyana threw herself from Castle Ravenloft's walls rather than be claimed by Strahd on his wedding day to her. She has been reincarnated many times over the centuries, and Strahd has pursued each incarnation, only to lose them to death or escape. Ireena is the latest - and perhaps final - incarnation."

# === METADATA ===
metadata:
  source: "Curse of Strahd"
  pageReference: "CoS p.43"
  official: true

  estimatedDuration: "1-2 sessions"

  tags: ["main_quest", "escort", "ireena", "strahd", "vallaki", "combat", "travel"]

  notes: "This quest is one of the first major story beats. It introduces Vallaki, establishes Strahd as an ever-present threat, and makes players care about Ireena. DO NOT kill Ireena casually - she's too important to the plot. If players fail, have Strahd take her to Castle Ravenloft, which sets up a rescue mission instead."

  developmentStage: "final"

# === TEMPLATE VERSION ===
templateVersion: "1.0.0"
compatibleWith: "Epic 2 EventScheduler (Story 2-3), Epic 1 StateManager"
