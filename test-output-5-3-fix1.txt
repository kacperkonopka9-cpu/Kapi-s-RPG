
> kapi-s-rpg@0.1.0 test
> jest tests/integration/prompts/template-engine.test.js

  console.debug
    [PromptTemplateEngine] Warning: Template location-return exceeds token budget by 17.7% (706 tokens vs 600 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:591:21)

  console.debug
    [PromptTemplateEngine] Warning: Template npc-dialogue exceeds token budget by 110.0% (840 tokens vs 400 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:591:21)

  console.debug
    [PromptTemplateEngine] Warning: Template combat-narration exceeds token budget by 93.4% (967 tokens vs 500 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:591:21)

  console.error
    consistency-validation error: Missing template variables: worldState.npcs

    [0m [90m 165 |[39m
     [90m 166 |[39m       [36mif[39m ([33m![39mresult[33m.[39msuccess) {
    [31m[1m>[22m[39m[90m 167 |[39m         console[33m.[39merror([32m'consistency-validation error:'[39m[33m,[39m result[33m.[39merror)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 168 |[39m       }
     [90m 169 |[39m
     [90m 170 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m[0m

      at Object.error (tests/integration/prompts/template-engine.test.js:167:17)

  console.debug
    [PromptTemplateEngine] Warning: Context has unused fields (possible typos): metadata, events, quests, contextMarkdown

      at PromptTemplateEngine.debug [as _checkUnusedFields] (src/prompts/template-engine.js:258:19)

  console.debug
    [PromptTemplateEngine] Warning: Template location-return exceeds token budget by 16.2% (697 tokens vs 600 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:591:21)

  console.debug
    [PromptTemplateEngine] Warning: Template npc-dialogue exceeds token budget by 102.0% (808 tokens vs 400 budget)

      at PromptTemplateEngine.debug [as renderTemplate] (src/prompts/template-engine.js:591:21)

  console.debug
    [PromptTemplateEngine] Registered custom template: custom-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:442:17)

  console.debug
    [PromptTemplateEngine] Registered custom template: custom-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:442:17)

  console.debug
    [PromptTemplateEngine] Registered custom template: custom-list-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:442:17)

  console.debug
    [PromptTemplateEngine] Registered custom template: duplicate-test

      at PromptTemplateEngine.debug [as registerTemplate] (src/prompts/template-engine.js:442:17)

  console.debug
    [PromptTemplateEngine] Warning: Context has unused fields (possible typos): self

      at PromptTemplateEngine.debug [as _checkUnusedFields] (src/prompts/template-engine.js:258:19)

FAIL tests/integration/prompts/template-engine.test.js
  PromptTemplateEngine
    Test Suite 1 - Template Rendering (AC-1, AC-2)
      âˆš should render location-initial-visit template with valid context (15 ms)
      âˆš should render location-return template with state changes (30 ms)
      âˆš should render npc-dialogue template with personality (8 ms)
      âˆš should render combat-narration template with damage (8 ms)
      Ã— should render consistency-validation template with rules (22 ms)
    Test Suite 2 - Variable Substitution (AC-1, AC-5)
      âˆš should substitute simple variables (2 ms)
      âˆš should substitute nested object properties (2 ms)
      âˆš should substitute array iterations with {{#each}} (3 ms)
      âˆš should handle optional variables with defaults (3 ms)
      âˆš should handle empty arrays gracefully (2 ms)
    Test Suite 3 - Token Budget Validation (AC-4)
      âˆš should include tokenCount in result metadata (2 ms)
      âˆš should include tokenBudget in result metadata (1 ms)
      âˆš should warn if token count exceeds budget by >10% but not block rendering (3 ms)
    Test Suite 4 - Missing Variable Handling (AC-5)
      âˆš should return error if required variable missing (3 ms)
      âˆš should identify all missing variables in error message (1 ms)
      âˆš should succeed if all required variables present (even if some optional missing) (2 ms)
    Test Suite 5 - Epic Integration (AC-6)
      âˆš should work with Story 5-1 ContextObject structure (11 ms)
      âˆš should access nested Epic 1-4 data correctly (2 ms)
    Test Suite 6 - DM Persona Integration (AC-3)
      âˆš should prepend DM persona to all rendered templates (2 ms)
      âˆš DM persona should appear before template content (3 ms)
      âˆš DM persona should be cached after first load (3 ms)
    Test Suite 7 - Template Caching (AC-1)
      âˆš should cache template after first load (1 ms)
      âˆš should cache multiple templates independently (3 ms)
    Test Suite 8 - Custom Templates (AC-1)
      âˆš should register custom template successfully (6 ms)
      âˆš should render registered custom template (3 ms)
      âˆš should list all available templates including registered ones (6 ms)
      âˆš should throw error if registering duplicate template (12 ms)
    Edge Cases and Error Handling
      âˆš should handle null or undefined context gracefully
      âˆš should handle invalid template ID (1 ms)
      âˆš should handle empty template ID (1 ms)
      âˆš should handle circular references in context gracefully (3 ms)

  â— PromptTemplateEngine â€º Test Suite 1 - Template Rendering (AC-1, AC-2) â€º should render consistency-validation template with rules

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 168 |[39m       }
     [90m 169 |[39m
    [31m[1m>[22m[39m[90m 170 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 171 |[39m       expect(result[33m.[39mdata[33m.[39mprompt)[33m.[39mtoContain([32m'Cast Misty Step'[39m)[33m;[39m
     [90m 172 |[39m       expect(result[33m.[39mdata[33m.[39mprompt)[33m.[39mtoContain([32m'0/3 remaining'[39m)[33m;[39m
     [90m 173 |[39m       expect(result[33m.[39mdata[33m.[39mprompt)[33m.[39mtoContain([32m'PHB p. 201'[39m)[33m;[39m[0m

      at Object.toBe (tests/integration/prompts/template-engine.test.js:170:30)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 30 passed, 31 total
Snapshots:   0 total
Time:        1.641 s, estimated 2 s
Ran all test suites matching /tests\\integration\\prompts\\template-engine.test.js/i.
